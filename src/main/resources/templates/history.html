<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Lịch sử dữ liệu</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
</head>
<body>
<div th:replace="fragments/header :: header"></div>

<main class="app-container">
    <div class="page-hero">
        <h1 class="hero-title">Lịch Sử Dự Báo</h1>
        <p class="hero-desc">Theo dõi độ chính xác của mô hình theo thời gian</p>
    </div>

    <div class="modern-card" style="margin-bottom: 2rem;">
        <h3 style="margin-bottom: 1rem;">Biểu đồ So sánh</h3>
        <div style="height: 350px;"><canvas id="comparisonChart"></canvas></div>
    </div>

    <div style="margin-bottom: 2rem; display: flex; justify-content: flex-end;">
        <form action="/history" method="get">
            <select name="locationId" onchange="this.form.submit()" class="inp" style="width: 250px;">
                <option value="">-- Tất cả khu vực --</option>
                <option th:each="loc : ${locations}" th:value="${loc.id}" th:text="${loc.name}" th:selected="${loc.id == selectedLocationId}"></option>
            </select>
        </form>
    </div>

    <div style="overflow-x: auto;">
        <table class="fancy-table">
            <thead>
            <tr>
                <th>Ngày</th>
                <th>Khu vực</th>
                <th>Dự báo</th>
                <th>Thực tế</th>
                <th>Trạng thái</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="hist : ${histories}">
                <td th:text="${hist.predictedForDate}"></td>
                <td th:text="${hist.location.name}" style="font-weight: 700; color: #1e293b;"></td>
                <td style="color: #2563eb; font-weight: bold;">
                    <span th:text="${#numbers.formatDecimal(hist.predictedRainfall, 1, 1)}"></span> mm
                </td>
                <td>
                    <span th:if="${hist.actualRainfall != null}" th:text="${hist.actualRainfall} + ' mm'"></span>
                    <span th:if="${hist.actualRainfall == null}" style="color: #cbd5e1;">---</span>
                </td>
                <td>
                    <span th:if="${hist.actualRainfall != null}" style="color: #10b981; font-size: 0.8rem; border: 1px solid #10b981; padding: 2px 8px; border-radius: 20px;">Hoàn thành</span>
                    <span th:if="${hist.actualRainfall == null}" style="color: #f59e0b; font-size: 0.8rem; border: 1px solid #f59e0b; padding: 2px 8px; border-radius: 20px;">Chờ duyệt</span>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</main>

<div th:replace="fragments/footer :: footer"></div>
<script th:inline="javascript">const serverHistoryData = /*[[${histories}]]*/ [];</script>
<script src="/js/history-chart.js"></script>
</body>
</html>