<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D·ª± b√°o m∆∞a Mi·ªÅn Trung - AI Forecast</title>
    <link rel="stylesheet" href="/css/style.css">
    <!-- Th∆∞ vi·ªán SweetAlert2 cho Popup ƒë·∫πp -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/animejs@3/lib/anime.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
</head>
<body>
<!-- Header d√πng c√∫ ph√°p m·ªõi -->
<div th:replace="~{fragments/header :: header}"></div>

<main class="app-container">
    <div class="page-hero">
        <h1 class="hero-title">D·ª± B√°o L∆∞·ª£ng M∆∞a AI</h1>
        <p class="hero-desc">S·ª≠ d·ª•ng Machine Learning & D·ªØ li·ªáu v·ªá tinh LST</p>

        <!-- [ƒê√É S·ª¨A] N√öT ƒêƒÇNG K√ù NH·∫¨N TIN - D√πng class btn-hero-action -->
        <button onclick="openSubscribeModal()" class="btn-hero-action">
            <span>üîî</span> ƒêƒÉng k√Ω nh·∫≠n c·∫£nh b√°o qua Email
        </button>
    </div>

    <div class="split-layout">
        <!-- KH·ªêI TR√ÅI: FORM NH·∫¨P LI·ªÜU -->
        <div class="modern-card">
            <h2 style="font-size: 1.25rem; margin-bottom: 1.5rem; color: #1e293b;">‚ö° D·ªØ li·ªáu ƒë·∫ßu v√†o</h2>

            <form id="predictForm">
                <div class="form-group">
                    <label class="lbl">Khu v·ª±c d·ª± b√°o</label>
                    <div style="position: relative;">
                        <select id="locationId" name="locationId" class="inp" required>
                            <option value="" disabled selected>-- Ch·ªçn T·ªânh/Th√†nh ph·ªë --</option>
                            <option th:each="loc : ${locations}" th:value="${loc.id}" th:text="${loc.name}"></option>
                        </select>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="lbl">Nhi·ªát ƒë·ªô (LST)</label>
                        <input type="number" id="lst" class="inp" step="any" placeholder="¬∞C" required>
                    </div>
                    <div class="form-group">
                        <label class="lbl">ƒê·ªô ·∫©m (%)</label>
                        <input type="number" id="humidity" class="inp" step="any" placeholder="%" required>
                    </div>
                    <div class="form-group">
                        <label class="lbl">Nhi·ªát ƒë·ªô KK</label>
                        <input type="number" id="temperature" class="inp" step="any" placeholder="¬∞C" required>
                    </div>
                    <div class="form-group">
                        <label class="lbl">T·ªëc ƒë·ªô gi√≥</label>
                        <input type="number" id="windSpeed" class="inp" step="any" placeholder="m/s" required>
                    </div>
                </div>

                <div style="display: flex; flex-direction: column; gap: 0.75rem; margin-top: 1rem;">
                    <button type="button" class="btn-modern btn-secondary" id="autoFillBtn">
                        üì° L·∫•y d·ªØ li·ªáu th·ªùi ti·∫øt hi·ªán t·∫°i
                    </button>
                    <button type="submit" class="btn-modern btn-primary" id="predictBtn">
                        üîÆ D·ª± b√°o ngay
                    </button>
                </div>
            </form>
        </div>

        <!-- KH·ªêI PH·∫¢I: K·∫æT QU·∫¢ -->
        <div style="height: 100%;">
            <div id="emptyState" class="modern-card" style="height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; opacity: 0.7;">
                <img src="https://cdn-icons-png.flaticon.com/512/1163/1163624.png" width="100" style="margin-bottom: 1rem; opacity: 0.5;" alt="Cloud">
                <h3 style="color: var(--text-gray);">Ch∆∞a c√≥ d·ªØ li·ªáu</h3>
                <p>Nh·∫≠p th√¥ng s·ªë b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu m√¥ ph·ªèng</p>
            </div>

            <div id="resultContainer" style="height: 100%; display: none;">
                <div id="weatherWindow" class="weather-window weather-clear">
                    <div class="weather-content">
                        <div style="font-size: 0.9rem; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 0.5rem;">D·ª± b√°o l∆∞·ª£ng m∆∞a</div>
                        <div class="big-temp">
                            <span id="rainfallValue">0</span><span style="font-size: 2rem; vertical-align: top;">mm</span>
                        </div>
                        <div id="weatherStatus" class="weather-status">ƒêang x·ª≠ l√Ω...</div>
                        <div id="weatherSub" class="weather-sub">...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<div th:replace="~{fragments/footer :: footer}"></div>
<script src="/js/dashboard.js"></script>

<!-- SCRIPT X·ª¨ L√ù ƒêƒÇNG K√ù EMAIL -->
<script>
    async function openSubscribeModal() {
        const optionsHtml = document.getElementById('locationId').innerHTML;

        const { value: formValues } = await Swal.fire({
            title: 'üì° ƒêƒÉng k√Ω c·∫£nh b√°o s·ªõm',
            html: `
                <p style="font-size: 0.9rem; color: #64748b; margin-bottom: 15px;">H·ªá th·ªëng s·∫Ω g·ª≠i Email cho b·∫°n khi d·ª± b√°o c√≥ m∆∞a l·ªõn (>50mm) t·∫°i khu v·ª±c b·∫°n ch·ªçn.</p>
                <input id="swal-email" class="swal2-input" placeholder="Nh·∫≠p Email c·ªßa b·∫°n" type="email">
                <select id="swal-loc" class="swal2-select" style="width: 80%; margin-top: 15px;">
                    ${optionsHtml}
                </select>
            `,
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: 'ƒêƒÉng K√Ω Ngay',
            cancelButtonText: 'H·ªßy',
            confirmButtonColor: '#0ea5e9',
            preConfirm: () => {
                const email = document.getElementById('swal-email').value;
                const locId = document.getElementById('swal-loc').value;

                if (!email || !email.includes('@')) {
                    Swal.showValidationMessage('Vui l√≤ng nh·∫≠p Email h·ª£p l·ªá');
                    return false;
                }
                if (!locId) {
                    Swal.showValidationMessage('Vui l√≤ng ch·ªçn khu v·ª±c');
                    return false;
                }
                return { email: email, locId: locId }
            }
        });

        if (formValues) {
            try {
                const formData = new FormData();
                formData.append('email', formValues.email);
                formData.append('locationId', formValues.locId);

                Swal.showLoading();

                const res = await fetch('/api/notify/subscribe', {
                    method: 'POST',
                    body: formData
                });

                if (res.ok) {
                    Swal.fire({
                        icon: 'success',
                        title: 'ƒêƒÉng k√Ω th√†nh c√¥ng!',
                        text: 'B·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c email c·∫£nh b√°o khi tr·ªùi m∆∞a to.',
                        timer: 3000
                    });
                } else {
                    const errData = await res.json();
                    Swal.fire('L·ªói', errData.error || 'C√≥ l·ªói x·∫£y ra', 'error');
                }
            } catch (e) {
                console.error(e);
                Swal.fire('L·ªói k·∫øt n·ªëi', 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß', 'error');
            }
        }
    }
</script>
</body>
</html>