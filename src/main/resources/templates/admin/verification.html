<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>X√°c th·ª±c k·∫øt qu·∫£ - RainAI</title>
  <link rel="stylesheet" href="/css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/animejs@3/lib/anime.min.js"></script>
</head>
<body>
<div class="admin-wrapper">
  <div th:replace="~{admin/fragments/sidebar :: sidebar}"></div>

  <div class="admin-main-panel">
    <div th:replace="~{admin/fragments/header :: header}"></div>

    <main class="admin-content">
      <h2 style="margin-bottom: 1.5rem; color: #0f172a;">K·∫øt qu·∫£ th·ª±c t·∫ø (C·∫ßn nh·∫≠p li·ªáu)</h2>

      <section class="modern-card" style="padding: 0; overflow: hidden;">

        <div style="padding: 1.5rem; background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
          <form action="/admin/verification" method="get" style="display: flex; gap: 1rem;">
            <select name="locationId" class="inp" style="max-width: 250px;" onchange="this.form.submit()">
              <option value="">-- T·∫•t c·∫£ khu v·ª±c --</option>
              <option th:each="loc : ${locations}"
                      th:value="${loc.id}"
                      th:text="${loc.name}"
                      th:selected="${loc.id == currentLocationId}"></option>
            </select>
          </form>
        </div>

        <div class="table-responsive">
          <table class="fancy-table">
            <thead>
            <tr>
              <th>ID</th> <th>Th·ªùi gian</th>
              <th>Tr·∫°m</th>
              <th>Input (LST/H/T/W)</th>
              <th>D·ª± b√°o</th>
              <th>T√°c v·ª•</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="item : ${dataPage.content}">
              <td th:text="${item.id}" style="font-weight: bold; color: #64748b;"></td> <td th:text="${#temporals.format(item.predictionTimestamp, 'dd/MM HH:mm')}"></td>
              <td th:text="${item.location.name}" style="font-weight: 600;"></td>
              <td style="font-family: monospace; color: #64748b;">
                <span th:text="${item.predictionFeature.inputLst}"></span> /
                <span th:text="${item.predictionFeature.inputHumidity}"></span> /
                <span th:text="${item.predictionFeature.inputTemp}"></span> /
                <span th:text="${item.predictionFeature.inputWindSpeed}"></span>
              </td>
              <td th:text="${#numbers.formatDecimal(item.predictedRainfall, 1, 1) + ' mm'}" style="color: #2563eb; font-weight: 700;"></td>
              <td>
                <button class="btn-modern btn-secondary" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; width: auto;"
                        th:onclick="'openModal(' + ${item.id} + ',' + ${item.predictedRainfall} + ')'">Update</button>

                <button class="btn-modern" style="background: #fee2e2; color: #ef4444; padding: 0.3rem 0.6rem; font-size: 0.8rem; width: auto; margin-left: 0.5rem;"
                        th:onclick="'deleteRecord(' + ${item.id} + ')'">üóëÔ∏è</button>
              </td>
            </tr>
            </tbody>
          </table>
        </div>

        <div class="pagination-container" th:if="${dataPage.totalPages > 1}" style="padding: 1rem; display: flex; justify-content: center; gap: 0.5rem;">
          <a th:href="@{/admin/verification(page=${currentPage - 1},
                  locationId=${locationId},
                  keyword=${keyword},
                  startDate=${startDate},
                  endDate=${endDate},
                  minRain=${minRain},
                  maxRain=${maxRain})}"
             class="btn-modern btn-secondary"
             th:classappend="${currentPage == 0} ? 'disabled'">Tr∆∞·ªõc</a>

          <span style="align-self: center;">Trang [[${currentPage + 1}]] / [[${dataPage.totalPages}]]</span>

          <a th:href="@{/admin/verification(page=${currentPage + 1},
                  locationId=${locationId},
                  keyword=${keyword},
                  startDate=${startDate},
                  endDate=${endDate},
                  minRain=${minRain},
                  maxRain=${maxRain})}"
             class="btn-modern btn-secondary"
             th:classappend="${currentPage + 1 == dataPage.totalPages} ? 'disabled'">Sau</a>
        </div>
      </section>
    </main>

    <div th:replace="~{admin/fragments/footer :: footer}"></div>
  </div>
</div>

<div id="dataModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(5px); z-index: 1000; align-items: center; justify-content: center;">
  <div class="modern-card" style="width: 400px; max-width: 90%;">
    <h3 style="margin-bottom: 1.5rem;">C·∫≠p nh·∫≠t th·ª±c t·∫ø</h3>
    <form id="dataForm">
      <input type="hidden" id="recordId">
      <div class="form-group">
        <label>D·ª± b√°o</label>
        <input type="text" id="forecastValue" disabled class="inp" style="background: #e2e8f0;">
      </div>
      <div class="form-group">
        <label>Th·ª±c t·∫ø (mm)</label>
        <input type="number" id="actualValue" step="0.1" class="inp" required>
      </div>
      <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
        <button type="button" class="btn-modern btn-secondary" style="flex: 1;" onclick="closeModal()">H·ªßy</button>
        <button type="submit" class="btn-modern btn-primary" style="flex: 1;">L∆∞u</button>
      </div>
    </form>
  </div>
</div>

<script>
  // Logic Modal
  function openModal(id, forecast) {
    document.getElementById('recordId').value = id;
    document.getElementById('forecastValue').value = forecast.toFixed(1) + ' mm';
    document.getElementById('actualValue').value = '';
    document.getElementById('dataModal').style.display = 'flex';
    document.getElementById('actualValue').focus();
  }
  function closeModal() { document.getElementById('dataModal').style.display = 'none'; }
  document.getElementById('dataForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = document.getElementById('recordId').value;
    const val = document.getElementById('actualValue').value;
    try {
      const res = await fetch('/admin/update-actual', {
          method: 'POST', headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({id: parseInt(id), actual_rainfall: parseFloat(val)})
      });
      if (res.ok) { window.location.reload(); }
    } catch (err) { alert('L·ªói'); }
  });

  // Logic X√≥a
  function deleteRecord(id) {
    Swal.fire({
        title: 'B·∫°n ch·∫Øc ch·∫Øn ch·ª©?',
        text: "D·ªØ li·ªáu s·∫Ω b·ªã x√≥a vƒ©nh vi·ªÖn!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        confirmButtonText: 'X√≥a ngay'
    }).then(async (result) => {
        if (result.isConfirmed) {
            try {
                const res = await fetch('/admin/delete-history', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({id: id})
                });
                if(res.ok) {
                    Swal.fire('ƒê√£ x√≥a!', '', 'success').then(() => location.reload());
                } else {
                    Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ x√≥a.', 'error');
                }
            } catch(e) { console.error(e); }
        }
    })
  }
</script>
</body>
</html>